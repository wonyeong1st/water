<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> </title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<!-- Intro Title Overlay -->
<div id="introTitle" class="fixed inset-0 flex items-center justify-center bg-gray-100 z-50">
  <div class="text-center transition-opacity duration-500 opacity-100">
    <div class="text-lg text-gray-600">ìƒìˆ˜ ì…ì¶œê³  ê´€ë¦¬</div>
    <div class="text-2xl font-extrabold mt-1">(ì£¼) ì‹ ì„±ì—í”„ì•¤ë””</div>
  </div>
</div>
<style>
  
  /* Mobile-friendly tap feedback */
  .tap-btn {
    transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
  }
  .tap-btn:active {
    transform: scale(0.96);
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.25);
    filter: brightness(0.95);
  }
  /* Global JS tap-active effect */
  .tap-active{
    transform: scale(0.97);
    filter: brightness(0.96);
  }

  /* STEP1: long-press visual */
  .long-press-active {
    transform: scale(0.98);
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    background-color: #f1f5f9;
  }

  /* long-press menu */
  .slip-action-menu {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .slip-action-box {
    background: white;
    border-radius: 16px;
    padding: 20px;
    width: 80%;
    max-width: 320px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  }

    /* ğŸ”’ ì•ˆë“œë¡œì´ë“œ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ (long-press ì „ìš©) */
  .no-select{
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    touch-action: none; /* pointer ì´ë²¤íŠ¸ì—ì„œ long-press í—ˆìš© */
  }
</style>
<script>
  // prevent native context menu globally on cards
  document.addEventListener('contextmenu', function(e){
    if (e.target.closest('.no-select')) {
      e.preventDefault();
      return false;
    }
  }, { passive:false });
</script>
  <div id="appHeader" style="display:none">
  <h1 class="mb-4 text-center">
    <div class="text-lg">ğŸš° ì…ì¶œê³  ê´€ë¦¬</div>
    <div class="text-2xl font-bold">(ì£¼) ì‹ ì„±ì—í”„ì•¤ë””</div>
  </h1>

  <!-- Top bar: totals -->
  <div class="max-w-3xl mx-auto mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
    <div class="bg-white rounded-2xl shadow p-4 text-center">
      <div class="text-sm text-gray-500">ê°œì¸ ì¬ê³  (18.9L)</div>
      <div id="myStock189" class="text-4xl font-extrabold">0</div>
    </div>
    <div class="bg-white rounded-2xl shadow p-4 text-right">
      <div class="text-sm text-gray-500 text-center">ëª…ì„± ì •ì‚° ëˆ„ì </div>
      <div id="sumM" class="text-2xl font-extrabold">0ì›</div>
    </div>
    <div class="bg-white rounded-2xl shadow p-4 text-right">
      <div class="text-sm text-gray-500 text-center">ìŒë´‰ ì •ì‚° ëˆ„ì </div>
      <div id="sumE" class="text-2xl font-extrabold">0ì›</div>
    </div>
  </div>

  <!-- Main nav -->
  <div class="max-w-3xl mx-auto mb-4 grid grid-cols-2 gap-3">
    <button class="tap-btn rounded-xl bg-red-600 text-white font-bold py-3" onclick="tap(); showShippingWith('ëª…ì„±')">ğŸšš ëª…ì„± ì¶œê³ </button>
    <button class="tap-btn rounded-xl bg-blue-600 text-white font-bold py-3" onclick="tap(); showShippingWith('ìŒë´‰')">ğŸšš ìŒë´‰ ì¶œê³ </button>
    <button class="tap-btn rounded-xl bg-slate-700 text-white font-bold py-3" onclick="tap(); show('hist_m')">ğŸ“¦ ëª…ì„±ì¡°íšŒ</button>
    <button class="tap-btn rounded-xl bg-slate-800 text-white font-bold py-3" onclick="tap(); show('hist_e')">ğŸ“¦ ìŒë´‰ì¡°íšŒ</button>
    <button class="tap-btn rounded-xl bg-emerald-600 text-white font-bold py-3" onclick="tap(); show('inbound')">ğŸ“¥ ì…ê³ /ë°˜ë‚©</button>
    <button class="tap-btn rounded-xl bg-orange-500 text-white font-bold py-3" onclick="tap(); show('settings')">âš™ ì„¤ì •</button>
  </div>
</div>

  <div id="screen" class="max-w-3xl mx-auto"></div>

  <script>
/************************************************************
 * STEP 3-2 (1ì°¨): êµ¬ì¡° ì •ë ¬ â€” ë™ì‘/í™”ë©´ ë³€ê²½ ì—†ìŒ
 * ëª©ì : ì´í›„ ìˆ˜ì • ì‹œ ì•ˆì •ì„± í™•ë³´ë¥¼ ìœ„í•œ êµ¬ì—­ í‘œì‹œë§Œ ì¶”ê°€
 * ë²”ìœ„: ì£¼ì„ ì¶”ê°€ ONLY (ì½”ë“œ ì´ë™/ì‚­ì œ/ë¡œì§ ë³€ê²½ ì—†ìŒ)
 ************************************************************/

// ===== ì„¹ì…˜ ëª©ì°¨ =====
// 1) Utils (ì§„ë™/ì‚¬ìš´ë“œ/ë‚ ì§œ/ì €ì¥)
// 2) Storage Keys + Defaults
// 3) Global State (ëŸ°íƒ€ì„ ìƒíƒœ)
// 4) Navigation / Routing
// 5) Screens (Home / Shipping / Inbound / History / Settings)
// 6) Gestures (Long-press ë“±)
// =====================

/********************
 * 1) Utils (ì§„ë™/ì‚¬ìš´ë“œ/ë‚ ì§œ/ì €ì¥)
 ********************/
// haptic + click feedback
  // haptic + click sound feedback
  let __audioCtx;
  function tap(){
    try{
      if (navigator.vibrate) navigator.vibrate(20);
      if (!__audioCtx) __audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (__audioCtx.state === 'suspended') __audioCtx.resume();
      const o = __audioCtx.createOscillator();
      const g = __audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = 320;
      g.gain.value = 0.06;
      o.connect(g); g.connect(__audioCtx.destination);
      o.start();
      o.stop(__audioCtx.currentTime + 0.05);
    }catch(e){}
  }

  // STEP2: gesture helper (future split candidate)
  /********************
 * 6) Gestures (Long-press ë“±)
 ********************/
function bindLongPress(el, onLong){
    let timer;
    el.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      timer = setTimeout(()=>{
        tap();
        el.classList.add('long-press-active');
        onLong();
      }, 550);
    });
    ['pointerup','pointerleave','pointercancel'].forEach(ev=>{
      el.addEventListener(ev, ()=>{
        clearTimeout(timer);
        el.classList.remove('long-press-active');
      });
    });
  }

  /********************
 * 2) Storage Keys + Defaults
 ********************/
  const KEYS = {
    items: 'items',
    outgo: 'outgoRecords',
    inbound: 'inboundRecords',
    myStock: 'myStock',
    containerHeld: 'containerHeld',
    settlement: 'settlement',
    personalRate: 'personalRate189',
    truckSize: 'truckSize864'
  };

  const DEFAULT_ITEMS = [
    { name:'18.9L', myeongseong:0, eumbong:1800, lock:true },
    { name:'2.0L', myeongseong:2000, eumbong:1850 },
    { name:'500ml', myeongseong:2150, eumbong:2600 },
    { name:'330ml', myeongseong:2600, eumbong:2508 },
    { name:'1.0L (12ê°œ)', myeongseong:2530, eumbong:2530 },
    { name:'ì¢…ì´ì»µ(6.5oz)', myeongseong:8100, eumbong:8800 },
    { name:'ë´‰íˆ¬ì»µ', myeongseong:13000, eumbong:0 },
    { name:'(ë™ì›)13L', myeongseong:2200, eumbong:0 }
  ];

  const CONTAINER_TYPES = [
    { key:'189_crate', label:'18.9L í¬ë ˆì´íŠ¸' },
    { key:'189_empty', label:'18.9L ë¹ˆí†µ' },
    { key:'13_crate',  label:'13L í¬ë ˆì´íŠ¸' },
    { key:'13_empty',  label:'13L ë¹ˆí†µ' }
  ];

  function loadJSON(key, fallback) {
    try {
      const v = localStorage.getItem(key);
      return v ? JSON.parse(v) : fallback;
    } catch {
      return fallback;
    }
  }
  function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
  function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  // Local date (YYYY-MM-DD) without UTC shift
  function toLocalISO(d){
    const x = new Date(d.getTime() - d.getTimezoneOffset()*60000);
    return x.toISOString().slice(0,10);
  }
  function todayISO(){ return toLocalISO(new Date()); }
  function uid(){ return Date.now() + Math.floor(Math.random()*1000); }
  function money(n){ return (num(n)).toLocaleString() + 'ì›'; }

  /********************
 * 3) Global State (ëŸ°íƒ€ì„ ìƒíƒœ)
 ********************/
// state
  let items = loadJSON(KEYS.items, DEFAULT_ITEMS);
  // STEP 3: ì „í‘œ ìˆ˜ì •ìš© ìƒíƒœ
  let editingRecord = null;
  let outgoRecords = loadJSON(KEYS.outgo, []);
  let inboundRecords = loadJSON(KEYS.inbound, []);
  let myStock = loadJSON(KEYS.myStock, { '18.9L': 0 });
  let containerHeld = loadJSON(KEYS.containerHeld, { ëª…ì„±:{}, ìŒë´‰:{} });
  let settlement = loadJSON(KEYS.settlement, { myeong:0, eumbong:0 });
  let personalRate = num(localStorage.getItem(KEYS.personalRate) || 1800);
  let truckSize = num(localStorage.getItem(KEYS.truckSize) || 864);

  // ensure containerHeld structure
  for (const wh of ['ëª…ì„±','ìŒë´‰']) {
    containerHeld[wh] = containerHeld[wh] || {};
    for (const t of CONTAINER_TYPES) if (containerHeld[wh][t.key] === undefined) containerHeld[wh][t.key] = 0;
  }

  // ensure 18.9L exists
  if (!items.find(x => x.name === '18.9L')) {
    items.unshift(DEFAULT_ITEMS[0]);
    saveJSON(KEYS.items, items);
  }

  function syncHeader(){
    document.getElementById('sumM').innerText = money(settlement.myeong);
    document.getElementById('sumE').innerText = money(settlement.eumbong);
    document.getElementById('myStock189').innerText = (myStock['18.9L'] || 0);
  }

  /********************
 * 5) Screens
 ********************/
  /********************
 * 4) Navigation / Routing
 * - show()
 * - showShippingWith()
 * - history / popstate
 ********************/
function show(name){
    // ë’¤ë¡œê°€ê¸° íˆìŠ¤í† ë¦¬ ì²˜ë¦¬ (ë©”ì¸ ì œì™¸)
    if (name !== 'home') {
      history.pushState({ screen: name }, '', '#'+name);
    }
    // STEP 2: ë©”ì¸ í™”ë©´ì´ ì•„ë‹ ë•Œ ìƒë‹¨ í—¤ë” ìˆ¨ê¹€
    const header = document.getElementById('appHeader');
    if (header) header.style.display = (name === 'home') ? 'block' : 'none';

    if (name === 'home') return renderHome();
    if (name === 'shipping') return renderShipping();
    if (name === 'inbound') return renderInbound();
    if (name === 'hist_m') return renderHistory('ëª…ì„±');
    if (name === 'hist_e') return renderHistory('ìŒë´‰');
    if (name === 'settings') return renderSettings();
  }

  function showShippingWith(wh){
    // ì¶œê³  ì§„ì…ì€ ë°˜ë“œì‹œ show('shipping')ì„ ê±°ì¹˜ê²Œ í•¨
    show('shipping');
    setTimeout(() => {
      const btn = document.querySelector(`.ship-wh-btn[data-wh="${wh}"]`);
      if (btn) btn.click();
    }, 0);
  }

  function __show_placeholder__(){
    if (name === 'home') return renderHome();
    if (name === 'shipping') return renderShipping();
    if (name === 'inbound') return renderInbound();
    if (name === 'hist_m') return renderHistory('ëª…ì„±');
    if (name === 'hist_e') return renderHistory('ìŒë´‰');
    if (name === 'settings') return renderSettings();
  }

  function renderHome(){
    const el = document.getElementById('screen');
    el.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="text-sm text-gray-500 text-center">ê°œì¸ ì¬ê³  (18.9L)</div>
          <div class="text-5xl font-extrabold mt-1 text-center">${myStock['18.9L'] || 0}</div>
          <div class="text-sm text-gray-500 mt-2">ëª…ì„±ì—ì„œ 18.9Lë¥¼ ì¶œê³ í•˜ë©´ ê°œì¸ ì¬ê³ ê°€ ìë™ ì°¨ê°ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="bg-white rounded-2xl shadow p-4">
          <div class="font-bold mb-2">ê³µë³‘/í¬ë ˆì´íŠ¸ ë³´ìœ  (ëª…ì„± ê¸°ì¤€)</div>
          <div class="grid grid-cols-1 gap-2 text-sm">
            ${CONTAINER_TYPES.map(t => `
              <div class="flex justify-between">
                <span>${t.label}</span>
                <span class="font-extrabold">${containerHeld['ëª…ì„±'][t.key] || 0}</span>
              </div>`).join('')}
          </div>
          <div class="text-xs text-gray-400 mt-2">â€» ìŒë´‰ ì°½ê³  ìˆ˜ëŸ‰ì€ ì…ê³ /ë°˜ë‚© ë©”ë‰´ì—ì„œ í™•ì¸</div>
        </div>
      </div>

      <div class="mt-4 bg-white rounded-2xl shadow p-4">
        <div class="font-bold mb-3">ë¹ ë¥¸ ì‹¤í–‰</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button class="tap-btn rounded-2xl bg-red-600 text-white font-extrabold py-6 text-xl shadow hover:scale-[1.02] transition" onclick="tap(); showShippingWith('ëª…ì„±')">ğŸšš ëª…ì„± ì¶œê³ </button>
          <button class="tap-btn rounded-2xl bg-blue-600 text-white font-extrabold py-6 text-xl shadow hover:scale-[1.02] transition" onclick="tap(); showShippingWith('ìŒë´‰')">ğŸšš ìŒë´‰ ì¶œê³ </button>
        </div>
      </div>
    `;
  }

  /********************
   * Shipping (ì¶œê³ )
   ********************/
  function renderShipping(){
    const el = document.getElementById('screen');
    el.innerHTML = `
      <div class="bg-white rounded-2xl shadow p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div class="text-xl font-extrabold">ğŸšš ì¶œê³ </div>
          <div class="text-sm text-gray-500">ë‚ ì§œëŠ” ê¸°ë³¸ ì˜¤ëŠ˜, í•„ìš” ì‹œ ê³¼ê±°ë¡œ ë³€ê²½</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm font-semibold">ì°½ê³ </label>
            <div class="flex gap-2" id="shipWarehouseWrap">
              <button data-wh="ëª…ì„±" class="ship-wh-btn flex-1 rounded-xl bg-rose-200 text-rose-900 font-extrabold py-2 border-4 border-rose-500">ëª…ì„±</button>
              <button data-wh="ìŒë´‰" class="ship-wh-btn flex-1 rounded-xl bg-sky-200 text-sky-900 font-extrabold py-2 border-2 border-transparent">ìŒë´‰</button>
            </div>
          </div>
          <div>
            <label class="text-sm font-semibold">ë‚ ì§œ</label>
            <input id="shipDate" type="date" class="w-full border p-2 rounded-xl bg-gray-50" />
          </div>
          <div>
            <label class="text-sm font-semibold">ì •ë ¬/ê³„ì‚°</label>
            <div class="text-sm text-gray-600 bg-gray-50 border rounded-xl p-2">
              ëª…ì„± 18.9L ë‹¨ê°€ëŠ” 0ì› (ê°œì¸ì¬ê³  ì°¨ê°)
            </div>
          </div>
        </div>

        <div class="border rounded-2xl p-3 bg-gray-50">
          <div class="font-bold mb-2">ì¶œê³  ìˆ˜ëŸ‰ ì…ë ¥</div>
          <div id="shipItems" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        </div>

        <div class="border rounded-2xl p-3 bg-gray-50">
          <div class="font-bold mb-2">ê³µë³‘/í¬ë ˆì´íŠ¸ ìˆ˜ê±° (ì„ íƒ)
            <span class="text-sm text-gray-500 font-normal">ë°°ì†¡í•˜ë©´ì„œ ê³ ê°ì—ê²Œì„œ ë°›ì€ ë¹ˆí†µ/í¬ë ˆì´íŠ¸ë¥¼ ê¸°ë¡ (ë¶ˆê· í˜• ê°€ëŠ¥)</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="collectBoxes"></div>
        </div>

        <div class="flex items-center justify-between bg-white border rounded-2xl p-4">
          <div class="font-bold">ì´ ê¸ˆì•¡</div>
          <div id="shipTotal" class="text-2xl font-extrabold text-blue-600">0ì›</div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button id="shipSave" class="rounded-2xl bg-red-600 text-white font-extrabold py-4 shadow">ì €ì¥</button>
          <button id="shipClear" class="rounded-2xl bg-gray-700 text-white font-bold py-4 shadow">ì…ë ¥ ì´ˆê¸°í™”</button>
        </div>

        <div class="text-sm text-gray-500">
          ì €ì¥ ì‹œ ê·œì¹™: (1) ëª…ì„± ì¶œê³ ì˜ 18.9LëŠ” ê°œì¸ ì¬ê³ ì—ì„œ ì°¨ê°ë˜ê³  ì •ì‚° ê¸ˆì•¡ì—ëŠ” ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (2) ëª…ì„± ì¶œê³ ì˜ ë‚˜ë¨¸ì§€ í’ˆëª©ì€ ëª…ì„± ì •ì‚°ì— ëˆ„ì ë©ë‹ˆë‹¤. (3) ìŒë´‰ ì¶œê³ ëŠ” ìŒë´‰ ë‹¨ê°€ë¡œ ìŒë´‰ ì •ì‚°ì— ëˆ„ì ë©ë‹ˆë‹¤.
        </div>
      </div>
    `;

    let selectedWarehouse = 'ëª…ì„±';

    const whButtons = document.querySelectorAll('.ship-wh-btn');

    function applyWarehouseStylesButtonsOnly(){
      whButtons.forEach(b => {
        b.classList.remove('border-4','border-rose-500','border-sky-500','shadow-lg','scale-95');
        b.classList.add('border-2','border-transparent','shadow','transition','duration-150');
        const chk = b.querySelector('.wh-check');
        if (chk) chk.remove();
      });
      const active = Array.from(whButtons).find(b => b.dataset.wh === selectedWarehouse);
      if (active) {
        active.classList.remove('border-2','border-transparent');
        active.classList.add('border-4','shadow-lg','scale-95');
        active.classList.add(selectedWarehouse === 'ëª…ì„±' ? 'border-rose-500' : 'border-sky-500');
        const span = document.createElement('span');
        span.className = 'wh-check ml-2 text-lg font-extrabold';
        span.innerText = 'âœ“';
        active.appendChild(span);
      }
    }

    function applyWarehouseStyles(){
      applyWarehouseStylesButtonsOnly();
      if (!shipItems) return;
      shipItems.querySelectorAll('input[type="number"]').forEach(inp => {
        inp.classList.remove('border-rose-400','border-sky-400');
        inp.classList.add(selectedWarehouse === 'ëª…ì„±' ? 'border-rose-400' : 'border-sky-400');
      });
      const totalEl = document.getElementById('shipTotal');
      totalEl.classList.remove('text-rose-600','text-sky-600');
      totalEl.classList.add(selectedWarehouse === 'ëª…ì„±' ? 'text-rose-600' : 'text-sky-600');
    }

    whButtons.forEach(btn => {
      btn.onclick = () => {
        selectedWarehouse = btn.dataset.wh;
        applyWarehouseStyles();
        // âœ ì „í‘œ ìˆ˜ì • ëª¨ë“œ: ìˆ˜ëŸ‰/ìˆ˜ê±° ê°’ ë³µì›
    if (editingRecord) {
      // ì¶œê³  í’ˆëª© ìˆ˜ëŸ‰ ë³µì›
      shipItems.querySelectorAll('input[data-idx]').forEach(inp => {
        const idx = Number(inp.dataset.idx);
        const name = items[idx].name;
        const found = (editingRecord.items || []).find(x => x.name === name);
        if (found) inp.value = found.qty;
      });
      // ìˆ˜ê±° ê³µë³‘/í¬ë ˆì´íŠ¸ ë³µì›
      collectBoxes.querySelectorAll('input[data-ct]').forEach(inp => {
        const k = inp.dataset.ct;
        if (editingRecord.collected && editingRecord.collected[k] !== undefined) {
          inp.value = editingRecord.collected[k];
        }
      });
      applyWarehouseStyles();
    }

    calcShipTotal();
      };
    });

    // NOTE: shipItems is not built yet here, so only apply button highlight
    applyWarehouseStylesButtonsOnly();

    // ë‚ ì§œ ê¸°ë³¸ê°’
    document.getElementById('shipDate').value = todayISO();

    // âœ ì „í‘œ ìˆ˜ì • ëª¨ë“œì¼ ê²½ìš°: ë‚ ì§œ/ì°½ê³ ë§Œ ìš°ì„  ì„¸íŒ…
    if (editingRecord) {
      selectedWarehouse = editingRecord.warehouse;
      document.getElementById('shipDate').value = editingRecord.date;
    }

    const shipItems = document.getElementById('shipItems');
    shipItems.innerHTML = items.map((it, idx) => `
        <div class="bg-white border rounded-2xl p-3 flex items-center justify-between gap-2">
          <div>
            <div class="font-bold">${it.name}</div>
            <div class="text-xs text-gray-500">ëª…ì„±: ${num(it.myeongseong)} / ìŒë´‰: ${num(it.eumbong)}</div>
          </div>
          <div class="flex items-center gap-1">
            <button class="qty-btn px-3 py-2 rounded-lg bg-gray-200 font-bold" data-step="-1" data-idx="${idx}">âˆ’</button>
            <input data-idx="${idx}" type="number" class="w-20 border p-2 rounded-xl text-right" value="0" />
            <button class="qty-btn px-3 py-2 rounded-lg bg-gray-200 font-bold" data-step="1" data-idx="${idx}">+</button>
          </div>
        </div>`).join('');

    const collectBoxes = document.getElementById('collectBoxes');
    collectBoxes.innerHTML = CONTAINER_TYPES.map(t => `
      <div class="bg-white border rounded-2xl p-3 flex items-center justify-between gap-2">
        <div class="font-bold">${t.label}</div>
        <div class="flex items-center gap-1">
          <button class="qty-btn px-3 py-2 rounded-lg bg-gray-200 font-bold" data-step="-1" data-ct="${t.key}">âˆ’</button>
          <input data-ct="${t.key}" type="number" class="w-20 border p-2 rounded-xl text-right" value="0" />
          <button class="qty-btn px-3 py-2 rounded-lg bg-gray-200 font-bold" data-step="1" data-ct="${t.key}">+</button>
        </div>
      </div>`).join('');

    // âœ ì „í‘œ ìˆ˜ì • ëª¨ë“œ: ì‹¤ì œ ì…ë ¥ê°’ ë³µì› (DOM ìƒì„± ì´í›„)
    if (editingRecord) {
      // ì¶œê³  í’ˆëª© ìˆ˜ëŸ‰ ë³µì›
      shipItems.querySelectorAll('input[data-idx]').forEach(inp => {
        const idx = Number(inp.dataset.idx);
        const name = items[idx].name;
        const found = (editingRecord.items || []).find(x => x.name === name);
        if (found) inp.value = found.qty;
      });
      // ìˆ˜ê±° ê³µë³‘/í¬ë ˆì´íŠ¸ ë³µì›
      collectBoxes.querySelectorAll('input[data-ct]').forEach(inp => {
        const k = inp.dataset.ct;
        if (editingRecord.collected && editingRecord.collected[k] !== undefined) {
          inp.value = editingRecord.collected[k];
        }
      });
    }


    function calcShipTotal(){
      let total = 0;
      shipItems.querySelectorAll('input[type="number"]').forEach(inp => {
        const idx = Number(inp.dataset.idx);
        const q = num(inp.value);
        if (q === 0) return;
        const it = items[idx];
        let price = selectedWarehouse === 'ëª…ì„±' ? num(it.myeongseong) : num(it.eumbong);
        if (selectedWarehouse === 'ëª…ì„±' && it.name === '18.9L') price = 0;
        total += q * price;
      });
      document.getElementById('shipTotal').innerText = money(total);
      return total;
    }

    shipItems.addEventListener('input', calcShipTotal);

    // + / - buttons for ship items
    shipItems.querySelectorAll('.qty-btn').forEach(btn => {
      btn.onclick = () => {
        tap();
        const idx = btn.dataset.idx;
        const step = Number(btn.dataset.step);
        const inp = shipItems.querySelector(`input[data-idx="${idx}"]`);
        inp.value = num(inp.value) + step;
        calcShipTotal();
      };
    });

    // + / - buttons for collect boxes
    collectBoxes.querySelectorAll('.qty-btn').forEach(btn => {
      btn.onclick = () => {
        tap();
        const key = btn.dataset.ct;
        const step = Number(btn.dataset.step);
        const inp = collectBoxes.querySelector(`input[data-ct="${key}"]`);
        inp.value = num(inp.value) + step;
      };
    });

    document.getElementById('shipClear').onclick = () => {
      shipItems.querySelectorAll('input[type="number"]').forEach(i => i.value = '0');
      collectBoxes.querySelectorAll('input[type="number"]').forEach(i => i.value = '0');
      calcShipTotal();
    };

    document.getElementById('shipSave').onclick = () => {
      const wh = selectedWarehouse;
      const date = document.getElementById('shipDate').value || todayISO();

      const lines = [];
      shipItems.querySelectorAll('input[type="number"]').forEach(inp => {
        const idx = Number(inp.dataset.idx);
        const q = num(inp.value);
        if (q !== 0) lines.push({ name: items[idx].name, qty: q });
      });

      const collected = {};
      collectBoxes.querySelectorAll('input[type="number"]').forEach(inp => {
        const k = inp.dataset.ct;
        const q = num(inp.value);
        if (q !== 0) collected[k] = q;
      });

      if (lines.length === 0 && Object.keys(collected).length === 0) {
        alert('ì¶œê³  ìˆ˜ëŸ‰ ë˜ëŠ” ìˆ˜ê±° ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // âœ ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ì „í‘œ ë¡¤ë°±
      if (editingRecord) {
        editingRecord.editedAt = Date.now();
        const r = editingRecord;
        if (r.items && r.items.length) {
          if (r.warehouse === 'ëª…ì„±') {
            for (const ln of r.items) {
              if (ln.name === '18.9L') {
                myStock['18.9L'] = num(myStock['18.9L']) + num(ln.qty);
              } else {
                const it = items.find(x => x.name === ln.name) || {};
                settlement.myeong -= num(ln.qty) * num(it.myeongseong);
              }
            }
          } else {
            for (const ln of r.items) {
              const it = items.find(x => x.name === ln.name) || {};
              settlement.eumbong -= num(ln.qty) * num(it.eumbong);
            }
          }
        }
        if (r.collected) {
          for (const k of Object.keys(r.collected)) {
            containerHeld[r.warehouse][k] = num(containerHeld[r.warehouse][k]) - num(r.collected[k]);
          }
        }
        outgoRecords = outgoRecords.filter(x => x.id !== r.id);
      
      }

      // â• ì‹ ê·œ(ë˜ëŠ” ìˆ˜ì • í›„) ë°˜ì˜
      if (lines.length > 0) {
        if (wh === 'ëª…ì„±') {
          for (const ln of lines) {
            if (ln.name === '18.9L') {
              myStock['18.9L'] = num(myStock['18.9L']) - num(ln.qty);
            } else {
              const it = items.find(x => x.name === ln.name) || {};
              settlement.myeong += num(ln.qty) * num(it.myeongseong);
            }
          }
        } else {
          for (const ln of lines) {
            const it = items.find(x => x.name === ln.name) || {};
            settlement.eumbong += num(ln.qty) * num(it.eumbong);
          }
        }
      }

      if (Object.keys(collected).length > 0) {
        for (const k of Object.keys(collected)) {
          containerHeld[wh][k] = num(containerHeld[wh][k]) + num(collected[k]);
        }
      }

      const record = { id: uid(), date, warehouse: wh, items: lines, collected, total: calcShipTotal(), ...(editingRecord ? { editedAt: Date.now() } : {}) };

      // â­ ë°©ê¸ˆ ì¶œê³ í•œ ì „í‘œ í‘œì‹œìš©
      localStorage.setItem('lastShipId', String(record.id));
      outgoRecords.push(record);

      saveJSON(KEYS.outgo, outgoRecords);
      saveJSON(KEYS.myStock, myStock);
      saveJSON(KEYS.containerHeld, containerHeld);
      saveJSON(KEYS.settlement, settlement);

      editingRecord = null;
      syncHeader();
      alert('ì¶œê³  ì €ì¥ ì™„ë£Œ');
      show(wh === 'ëª…ì„±' ? 'hist_m' : 'hist_e');
    };

    calcShipTotal();
  }

  /********************
   * Inbound/Return (ì…ê³ /ë°˜ë‚©)
   ********************/
  function renderInbound(){
    const el = document.getElementById('screen');
    el.innerHTML = `
      <div class="space-y-4">
        <!-- ê³µë³‘/í¬ë ˆì´íŠ¸ ë°˜ë‚©(ì°½ê³ ë¡œ) -->
        <div class="bg-white rounded-2xl shadow p-4 space-y-4">
          <div class="text-xl font-extrabold">ğŸ“¥ ì…ê³ /ë°˜ë‚©</div>
          <div class="text-sm text-gray-500">ìì£¼ í•˜ëŠ” ì‘ì—…: ê³µë³‘/í¬ë ˆì´íŠ¸ <span class="font-semibold">ì°½ê³  ë°˜ë‚©</span> (ë‚´ ë³´ìœ  ìˆ˜ëŸ‰ì—ì„œ ì°¨ê°)</div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm font-semibold">ë°˜ë‚© ì°½ê³ </label>
              <select id="retWarehouse" class="w-full border p-2 rounded-xl bg-gray-50">
                <option value="ëª…ì„±">ëª…ì„±</option>
                <option value="ìŒë´‰">ìŒë´‰</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-semibold">ë‚ ì§œ</label>
              <input id="retDate" type="date" class="w-full border p-2 rounded-xl bg-gray-50" />
            </div>
            <div>
              <label class="text-sm font-semibold">í•œ ì°¨ ìˆ˜ëŸ‰</label>
              <input id="truckSize" type="number" class="w-full border p-2 rounded-xl bg-gray-50" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="retGrid"></div>

          <div class="grid grid-cols-2 gap-3">
            <button id="retSave" class="rounded-2xl bg-emerald-600 text-white font-extrabold py-4 shadow">ë°˜ë‚© ì €ì¥</button>
            <button id="retClear" class="rounded-2xl bg-gray-700 text-white font-bold py-4 shadow">ì…ë ¥ ì´ˆê¸°í™”</button>
          </div>

          <div class="text-sm text-gray-500">â€» ë°˜ë‚©ì€ ì •ì‚° ê¸ˆì•¡ì— ì˜í–¥ì´ ì—†ìŠµë‹ˆë‹¤. (ê³µë³‘/í¬ë ˆì´íŠ¸ëŠ” ìˆ˜ëŸ‰ ê´€ë¦¬ìš©)</div>
        </div>

        <!-- ê°œì¸ ì¬ê³  18.9L ì…ê³  (í•˜ë‹¨) -->
        <div class="bg-white rounded-2xl shadow p-4 space-y-4">
          <div class="flex items-center justify-between">
            <div class="text-xl font-extrabold">ğŸ· ê°œì¸ ì¬ê³  18.9L ì…ê³ </div>
            <div class="text-sm text-gray-500">(í•œ ë‹¬ 1~2íšŒ)</div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm font-semibold">ë‚ ì§œ</label>
              <input id="pDate" type="date" class="w-full border p-2 rounded-xl bg-gray-50" />
            </div>
            <div>
              <label class="text-sm font-semibold">ì •ì‚° ë‹¨ê°€</label>
              <input id="pRate" type="number" class="w-full border p-2 rounded-xl bg-gray-50" />
            </div>
            <div>
              <label class="text-sm font-semibold">í•œ ì°¨ ìˆ˜ëŸ‰</label>
              <input id="pTruck" type="number" class="w-full border p-2 rounded-xl bg-gray-50" />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <button id="pTruckBtn" class="rounded-2xl bg-purple-600 text-white font-extrabold py-4 shadow">í•œ ì°¨ ì…ê³  (+ìˆ˜ëŸ‰)</button>
            <div class="flex gap-2">
              <input id="pQty" type="number" class="flex-1 border p-2 rounded-xl bg-gray-50" placeholder="ì§ì ‘ ìˆ˜ëŸ‰" />
              <button id="pQtyBtn" class="rounded-2xl bg-purple-700 text-white font-bold px-4">ì…ê³ </button>
            </div>
          </div>

          <div class="text-sm text-gray-500">â€» ê°œì¸ ì¬ê³  <span class="font-semibold">ì…ê³  ê¸ˆì•¡(ìˆ˜ëŸ‰Ã—ë‹¨ê°€)</span>ë§Œ ìŒë´‰ ì •ì‚°ì— ì¦‰ì‹œ ëˆ„ì ë©ë‹ˆë‹¤. ì¶œê³ (ëª…ì„± 18.9L)ëŠ” ì •ì‚°ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    `;

    // defaults
    document.getElementById('retDate').value = todayISO();
    document.getElementById('truckSize').value = truckSize;
    document.getElementById('pDate').value = todayISO();
    document.getElementById('pRate').value = personalRate;
    document.getElementById('pTruck').value = truckSize;

    // build return grid
    const retGrid = document.getElementById('retGrid');
    retGrid.innerHTML = CONTAINER_TYPES.map(t => {
      return `
        <div class="bg-gray-50 border rounded-2xl p-3 space-y-2">
          <div class="flex justify-between items-center">
            <div class="font-bold">${t.label}</div>
            <div class="text-xs text-gray-500">ë³´ìœ : <span id="held_${t.key}" class="text-2xl font-extrabold">0</span></div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <button data-car="${t.key}" class="rounded-xl bg-slate-800 text-white font-bold py-2">í•œ ì°¨ ë°˜ë‚© (-)</button>
            <input data-qty="${t.key}" type="number" class="border p-2 rounded-xl text-right" value="0" />
          </div>
        </div>`;
    }).join('');

    function refreshHeld(){
      const wh = document.getElementById('retWarehouse').value;
      for (const t of CONTAINER_TYPES) {
        const span = document.getElementById('held_' + t.key);
        if (span) span.innerText = num(containerHeld[wh][t.key]);
      }
    }

    document.getElementById('retWarehouse').addEventListener('change', refreshHeld);

    // one-car buttons
    retGrid.querySelectorAll('button[data-car]').forEach(btn => {
      btn.onclick = () => {
        const key = btn.dataset.car;
        const wh = document.getElementById('retWarehouse').value;
        const size = num(document.getElementById('truckSize').value);
        // subtract from held
        containerHeld[wh][key] = num(containerHeld[wh][key]) - size;
        saveJSON(KEYS.containerHeld, containerHeld);
        refreshHeld();
        syncHeader();
      };
    });

    document.getElementById('retClear').onclick = () => {
      retGrid.querySelectorAll('input[data-qty]').forEach(i => i.value = '0');
    };

    document.getElementById('retSave').onclick = () => {
      const wh = document.getElementById('retWarehouse').value;
      const date = document.getElementById('retDate').value || todayISO();
      const size = num(document.getElementById('truckSize').value);
      truckSize = size || truckSize;
      localStorage.setItem(KEYS.truckSize, String(truckSize));

      const changes = {};
      retGrid.querySelectorAll('input[data-qty]').forEach(inp => {
        const key = inp.dataset.qty;
        const q = num(inp.value);
        if (q !== 0) {
          containerHeld[wh][key] = num(containerHeld[wh][key]) - q;
          changes[key] = -q;
        }
      });

      if (Object.keys(changes).length === 0) {
        // still allow saving if user only used one-car buttons? We record a note.
        // We'll store a record if any held changed since last save is hard to detect; so require at least one manual input.
        alert('ì €ì¥í•  ë°˜ë‚© ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (í•œ ì°¨ ë²„íŠ¼ë§Œ ëˆŒë €ë‹¤ë©´, ê¸°ë¡ì´ í•„ìš”í•˜ë©´ ìˆ˜ëŸ‰ ì¹¸ì— ë™ì¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ ì €ì¥í•´ì£¼ì„¸ìš”)');
        saveJSON(KEYS.containerHeld, containerHeld);
        refreshHeld();
        syncHeader();
        return;
      }

      const rec = { id: uid(), date, warehouse: wh, type: 'container_return', changes };
      inboundRecords.push(rec);
      saveJSON(KEYS.inbound, inboundRecords);
      saveJSON(KEYS.containerHeld, containerHeld);
      refreshHeld();
      syncHeader();
      alert('ë°˜ë‚© ì €ì¥ ì™„ë£Œ');
      show('home');
    };

    // personal inbound
    document.getElementById('pTruckBtn').onclick = () => {
      const date = document.getElementById('pDate').value || todayISO();
      personalRate = num(document.getElementById('pRate').value) || personalRate;
      localStorage.setItem(KEYS.personalRate, String(personalRate));
      const qty = num(document.getElementById('pTruck').value);
      if (!qty) return alert('í•œ ì°¨ ìˆ˜ëŸ‰ì´ 0ì…ë‹ˆë‹¤.');

      myStock['18.9L'] = num(myStock['18.9L']) + qty;
      settlement.eumbong += qty * personalRate;

      const rec = { id: uid(), date, type: 'personal_inbound', qty, unitPrice: personalRate, amount: qty*personalRate };
      inboundRecords.push(rec);

      saveJSON(KEYS.myStock, myStock);
      saveJSON(KEYS.settlement, settlement);
      saveJSON(KEYS.inbound, inboundRecords);

      syncHeader();
      alert(`ê°œì¸ ì¬ê³  ì…ê³  ì™„ë£Œ (+${qty})
ìŒë´‰ ì •ì‚° +${money(qty*personalRate)}`);
      show('home');
    };

    document.getElementById('pQtyBtn').onclick = () => {
      const date = document.getElementById('pDate').value || todayISO();
      personalRate = num(document.getElementById('pRate').value) || personalRate;
      localStorage.setItem(KEYS.personalRate, String(personalRate));
      const qty = num(document.getElementById('pQty').value);
      if (!qty) return alert('ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      myStock['18.9L'] = num(myStock['18.9L']) + qty;
      settlement.eumbong += qty * personalRate;

      const rec = { id: uid(), date, type: 'personal_inbound', qty, unitPrice: personalRate, amount: qty*personalRate };
      inboundRecords.push(rec);

      saveJSON(KEYS.myStock, myStock);
      saveJSON(KEYS.settlement, settlement);
      saveJSON(KEYS.inbound, inboundRecords);

      syncHeader();
      alert(`ê°œì¸ ì¬ê³  ì…ê³  ì™„ë£Œ (+${qty})
ìŒë´‰ ì •ì‚° +${money(qty*personalRate)}`);
      show('home');
    };

    refreshHeld();
  }

  /********************
   * History (ì¡°íšŒ)
   ********************/
  function renderHistory(warehouse){
    // slip action menu (edit/delete)
    function openSlipActionMenu(record){
      const overlay = document.createElement('div');
      overlay.className = 'slip-action-menu';
      overlay.innerHTML = `
        <div class="slip-action-box space-y-3">
          <div class="font-extrabold text-lg">ì „í‘œ ê´€ë¦¬</div>
          <div class="text-sm text-gray-500">ì„ íƒí•œ ì „í‘œë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          <button id="slipEdit" class="w-full rounded-xl bg-blue-600 text-white font-bold py-3">âœ ìˆ˜ì •</button>
          <button id="slipDelete" class="w-full rounded-xl bg-red-600 text-white font-bold py-3">ğŸ—‘ ì‚­ì œ</button>
          <button id="slipCancel" class="w-full rounded-xl bg-gray-300 font-bold py-2">ì·¨ì†Œ</button>
        </div>`;

      function close(){
        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
      }

      overlay.addEventListener('click', (e) => {
        // ë°”ê¹¥(ì˜¤ë²„ë ˆì´)ì„ ëˆ„ë¥´ë©´ ë‹«ê¸°
        if (e.target === overlay) close();
      });

      overlay.querySelector('#slipCancel').onclick = () => close();

      overlay.querySelector('#slipDelete').onclick = () => {
        if(!confirm("ì´ ì „í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?\n(ì¬ê³  ë° ì •ì‚°ë„ í•¨ê»˜ ë˜ëŒë¦½ë‹ˆë‹¤)")) return;

        // ğŸ” ë¡¤ë°± ì²˜ë¦¬ (ì¶œê³  í’ˆëª©)
        if(record.items && record.items.length){
          if(record.warehouse === 'ëª…ì„±'){
            for(const ln of record.items){
              if(ln.name === '18.9L'){
                myStock['18.9L'] = num(myStock['18.9L']) + num(ln.qty);
              } else {
                const it = items.find(x=>x.name===ln.name)||{};
                settlement.myeong -= num(ln.qty) * num(it.myeongseong);
              }
            }
          } else {
            for(const ln of record.items){
              const it = items.find(x=>x.name===ln.name)||{};
              settlement.eumbong -= num(ln.qty) * num(it.eumbong);
            }
          }
        }

        // ğŸ” ë¡¤ë°± ì²˜ë¦¬ (ìˆ˜ê±° ê³µë³‘/í¬ë ˆì´íŠ¸)
        if(record.collected){
          for(const k of Object.keys(record.collected)){
            containerHeld[record.warehouse][k] = num(containerHeld[record.warehouse][k]) - num(record.collected[k]);
          }
        }

        // ì „í‘œ ì‚­ì œ
        outgoRecords = outgoRecords.filter(r=> r.id !== record.id);

        // ì €ì¥
        saveJSON(KEYS.outgo, outgoRecords);
        saveJSON(KEYS.myStock, myStock);
        saveJSON(KEYS.containerHeld, containerHeld);
        saveJSON(KEYS.settlement, settlement);

        syncHeader();
        close();
        alert('ì „í‘œê°€ ì‚­ì œë˜ê³  ì¬ê³ /ì •ì‚°ì´ ë˜ëŒë ¤ì¡ŒìŠµë‹ˆë‹¤');
        show(record.warehouse === 'ëª…ì„±' ? 'hist_m' : 'hist_e');
      };

      overlay.querySelector('#slipEdit').onclick = () => {
        // STEP 3-0: ìˆ˜ì • ëª¨ë“œ ì§„ì… (ì „í‘œì˜ ì°½ê³  ê·¸ëŒ€ë¡œ ì¶œê³  í™”ë©´ì— ë°˜ì˜)
        editingRecord = record;
        close();
        // ğŸ‘‰ ì „í‘œì˜ ì°½ê³ ë¥¼ ê·¸ëŒ€ë¡œ ì„ íƒí•œ ìƒíƒœë¡œ ì¶œê³  í™”ë©´ ì§„ì…
        showShippingWith(record.warehouse);
      };

      document.body.appendChild(overlay);
    }

    const el = document.getElementById('screen');
    el.innerHTML = `
      <div class="bg-white rounded-2xl shadow p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div class="text-xl font-extrabold">ğŸ“¦ ${warehouse} ì¶œê³  ì¡°íšŒ</div>
          <div class="text-sm text-gray-500">ì „í‘œë³„(ìµœì‹ ìˆœ) / í’ˆëª©ë³„ í•©ê³„</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm font-semibold">ê¸°ê°„ ì„¤ì •</label>
            <select id="hQuick" class="w-full border p-2 rounded-xl bg-gray-50">
              <option value="">ì„ íƒ ì•ˆí•¨</option>
              <option value="this">ì´ë²ˆ ë‹¬</option>
              <option value="last">ì§€ë‚œ ë‹¬</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-semibold">ì‹œì‘ì¼</label>
            <input id="hStart" type="date" class="w-full border p-2 rounded-xl bg-gray-50" />
          </div>
          <div>
            <label class="text-sm font-semibold">ì¢…ë£Œì¼</label>
            <input id="hEnd" type="date" class="w-full border p-2 rounded-xl bg-gray-50" />
          </div>
          <div>
            <label class="text-sm font-semibold">ë³´ê¸°</label>
            <select id="hMode" class="w-full border p-2 rounded-xl bg-gray-50">
              <option value="slip">ì „í‘œë³„ ë³´ê¸° (ìµœì‹ ìˆœ)</option>
              <option value="item">í’ˆëª©ë³„ í•©ê³„ ë³´ê¸°</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <button id="hSearch" class="rounded-2xl bg-blue-600 text-white font-extrabold py-3 shadow">ê²€ìƒ‰</button>
          <button id="hCSV" class="rounded-2xl bg-emerald-700 text-white font-bold py-3 shadow">CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div id="hResult" class="space-y-3"></div>
      </div>
    `;

    const hStart = document.getElementById('hStart');
    const hEnd = document.getElementById('hEnd');
    const hQuick = document.getElementById('hQuick');

    const today = new Date();
    // ğŸ”¹ ê¸°ë³¸ê°’: ì´ë²ˆ ë‹¬
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    hQuick.value = 'this';
    hStart.value = toLocalISO(monthStart);
    hEnd.value = toLocalISO(today);

    function setQuickRange(type){
      const now = new Date();
      if(type === 'this'){
        const s = new Date(now.getFullYear(), now.getMonth(), 1);
        hStart.value = toLocalISO(s);
        hEnd.value = toLocalISO(now);
      }
      if(type === 'last'){
        const s = new Date(now.getFullYear(), now.getMonth()-1, 1);
        const e = new Date(now.getFullYear(), now.getMonth(), 0);
        hStart.value = toLocalISO(s);
        hEnd.value = toLocalISO(e);
      }
    }

    hQuick.onchange = () => {
      if(hQuick.value) setQuickRange(hQuick.value);
    };

    function getFiltered(){
      const s = hStart.value, e = hEnd.value;
      return outgoRecords.filter(r => r.warehouse === warehouse && r.date >= s && r.date <= e);
    }

    const runSearch = () => {
      const mode = document.getElementById('hMode').value;
      const res = document.getElementById('hResult');
      const filtered = getFiltered();
      res.innerHTML = '';

      if (filtered.length === 0) {
        res.innerHTML = `<div class="text-center text-gray-500">ì¶œê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      if (mode === 'slip') {
        const sorted = [...filtered].sort((a,b) => {
          if (a.date !== b.date) return a.date < b.date ? 1 : -1;
          return b.id - a.id;
        });
        for (const r of sorted) {
          const itemsHtml = (r.items || []).map(i => `<div class='text-sm'>- ${i.name}: ${i.qty}ê°œ</div>`).join('') || `<div class='text-sm text-gray-400'>(ì¶œê³  í’ˆëª© ì—†ìŒ)</div>`;
          const collectHtml = r.collected && Object.keys(r.collected).length ? `
            <div class='mt-2 text-sm text-gray-700'>
              <div class='font-semibold'>ìˆ˜ê±°</div>
              ${Object.keys(r.collected).map(k => {
                const label = (CONTAINER_TYPES.find(t=>t.key===k)||{}).label || k;
                return `<div>- ${label}: ${r.collected[k]}</div>`;
              }).join('')}
            </div>` : '';

          const card = document.createElement('div');
          const isEdited = !!r.editedAt;
          const isRecent = r.id === loadJSON('lastShipId', null);
          card.classList.add('no-select');
          card.className = 'bg-gray-50 border rounded-2xl p-4';
          card.innerHTML = `
            <div class='flex justify-between items-start'>
              <div>
                <div class='font-extrabold'>${r.date} ${isEdited ? `<span class="ml-2 px-2 py-0.5 rounded-full bg-yellow-200 text-yellow-800 text-xs font-bold">ìˆ˜ì •ë¨</span>` : ''}</div>
                <div class='text-sm text-gray-500'>${r.warehouse}</div>
              </div>
              <div class='text-right'>
                <div class='text-lg font-extrabold ${isRecent ? 'text-emerald-600' : 'text-blue-700'}'>${money(r.total || 0)}</div>
              </div>
            </div>
            <div class='mt-2 ${isRecent ? 'ring-2 ring-emerald-400 rounded-xl p-2' : ''}'>${itemsHtml}</div>
            ${collectHtml}
          `;
          let pressTimer;
          card.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            pressTimer = setTimeout(() => {
              tap();
              card.classList.add('long-press-active');
              openSlipActionMenu(r);
            }, 550);
          });
          card.addEventListener('pointerup', () => {
            clearTimeout(pressTimer);
            card.classList.remove('long-press-active');
          });
          card.addEventListener('pointerleave', () => clearTimeout(pressTimer));
          card.addEventListener('pointercancel', () => clearTimeout(pressTimer));

          res.appendChild(card);
        }
      } else {
        const summary = {};
        for (const r of filtered) {
          for (const it of (r.items || [])) {
            summary[it.name] = (summary[it.name] || 0) + num(it.qty);
          }
        }

        const box = document.createElement('div');
        box.className = 'bg-gray-50 border rounded-2xl p-4';
        let total = 0;
        let rows = '';
        for (const name of Object.keys(summary)) {
          const qty = summary[name];
          const info = items.find(x => x.name === name) || {};
          const price = warehouse === 'ëª…ì„±' ? num(info.myeongseong) : num(info.eumbong);
          const sum = qty * price;
          total += sum;
          rows += `<div class='flex justify-between py-1 border-b'><div>${name} <span class='text-gray-500 text-sm'>(${qty}ê°œ)</span></div><div class='font-semibold'>${money(sum)}</div></div>`;
        }
        box.innerHTML = `
          <div class='font-extrabold mb-2'>í’ˆëª©ë³„ í•©ê³„</div>
          <div>${rows}</div>
          <div class='mt-3 flex justify-between text-lg font-extrabold'><span>ì´ í•©ê³„</span><span class='text-blue-700'>${money(total)}</span></div>
          <div class='text-sm text-gray-500 mt-2'>â€» ëª…ì„±ì˜ 18.9L ë‹¨ê°€ëŠ” 0ì›ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</div>
        `;
        res.appendChild(box);
      }
    };

    document.getElementById('hSearch').onclick = runSearch;

    // ğŸ”¹ ê¸°ë³¸ ë™ì‘: í™”ë©´ ì—´ë¦¬ìë§ˆì ê²€ìƒ‰ ì‹¤í–‰
    document.getElementById('hMode').value = 'slip';
    setTimeout(runSearch, 0);

    // CSV ë‹¤ìš´ë¡œë“œ


    document.getElementById('hCSV').onclick = () => {
      const filtered = getFiltered();
      if (filtered.length === 0) return alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      let csv = 'date,warehouse,item,qty,total\n';
      for (const r of filtered) {
        if (r.items && r.items.length) {
          for (const it of r.items) {
            csv += `${r.date},${r.warehouse},${it.name},${it.qty},${r.total || 0}\n`;
          }
        } else {
          csv += `${r.date},${r.warehouse},(none),0,${r.total || 0}\n`;
        }
      }
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${warehouse}_ì¶œê³ _${hStart.value}_${hEnd.value}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };
  }

  /********************
   * Settings
   ********************/
  function renderSettings(){
    const el = document.getElementById('screen');
    el.innerHTML = `
      <div class="space-y-4">
        <div class="bg-white rounded-2xl shadow p-4 space-y-3">
          <div class="text-xl font-extrabold">âš™ ì„¤ì • (í’ˆëª©/ë‹¨ê°€)</div>
          <div class="text-sm text-gray-500">ë‹¨ê°€/í’ˆëª©ì€ ìˆ˜ë…„ì— í•œ ë²ˆ ë°”ë€” ìˆ˜ ìˆìœ¼ë‹ˆ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤.</div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="bg-gray-50 border rounded-2xl p-3">
              <div class="text-sm text-gray-500">ê°œì¸ì¬ê³  18.9L ì •ì‚° ë‹¨ê°€</div>
              <input id="setRate" type="number" class="w-full border p-2 rounded-xl mt-2" />
            </div>
            <div class="bg-gray-50 border rounded-2xl p-3">
              <div class="text-sm text-gray-500">í•œ ì°¨ ìˆ˜ëŸ‰(ê¸°ë³¸)</div>
              <input id="setTruck" type="number" class="w-full border p-2 rounded-xl mt-2" />
            </div>
            <div class="bg-gray-50 border rounded-2xl p-3">
              <div class="text-sm text-gray-500">ì›”ì´ˆ ì´ˆê¸°í™”</div>
              <button id="resetMonth" class="w-full mt-2 rounded-xl bg-slate-800 text-white font-bold py-2">ì •ì‚°ë§Œ 0ìœ¼ë¡œ</button>
            </div>
          </div>

          <div class="flex justify-end">
            <button id="saveBasics" class="rounded-2xl bg-blue-600 text-white font-extrabold py-3 px-5 shadow">ê¸°ë³¸ê°’ ì €ì¥</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow p-4 space-y-3">
          <div class="font-extrabold">í’ˆëª© ëª©ë¡</div>
          <div class="text-sm text-gray-500">ëª…ì„±/ìŒë´‰ ë‹¨ê°€ë¥¼ ê°ê° í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          <div id="itemsTable" class="space-y-2"></div>
          <div class="flex gap-2">
            <button id="addItem" class="rounded-xl bg-emerald-600 text-white font-bold py-2 px-4">+ í’ˆëª© ì¶”ê°€</button>
            <button id="saveItems" class="rounded-xl bg-blue-600 text-white font-bold py-2 px-4">ì €ì¥</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow p-4 space-y-3">
          <div class="font-extrabold">ğŸ’¾ ë°ì´í„° ë°±ì—… / ë³µì›</div>
          <div class="text-sm text-gray-500">PCì—ì„œ ì…ë ¥í•œ ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ê³ , ë‹¤ë¥¸ ê¸°ê¸°(ì•ˆë“œë¡œì´ë“œ)ì—ì„œ ê·¸ëŒ€ë¡œ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <button id="backupBtn" class="rounded-2xl bg-indigo-600 text-white font-extrabold py-3 shadow">ğŸ“¥ ë°ì´í„° ë°±ì—…</button>
            <label class="rounded-2xl bg-indigo-100 text-indigo-800 font-bold py-3 shadow flex items-center justify-center cursor-pointer">
              ğŸ“¤ ë°ì´í„° ë³µì›
              <input id="restoreInput" type="file" accept="application/json" class="hidden" />
            </label>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow p-4 space-y-3">
          <div class="font-extrabold text-red-700">âš  ë°ì´í„° ì´ˆê¸°í™”</div>
          <div class="text-sm text-gray-500">ìš´ì˜ ì‹œì‘ ì „/í…ŒìŠ¤íŠ¸ í›„ ì „ì²´ ë°ì´í„°ë¥¼ 0ìœ¼ë¡œ ëŒë¦½ë‹ˆë‹¤. ì‹¤ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•´ í™•ì¸ì°½ì´ ëœ¹ë‹ˆë‹¤.</div>
          <button id="resetAll" class="w-full rounded-2xl bg-red-700 text-white font-extrabold py-4 shadow">ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
      </div>
    `;

    document.getElementById('setRate').value = personalRate;
    document.getElementById('setTruck').value = truckSize;

    document.getElementById('saveBasics').onclick = () => {
      personalRate = num(document.getElementById('setRate').value) || personalRate;
      truckSize = num(document.getElementById('setTruck').value) || truckSize;
      localStorage.setItem(KEYS.personalRate, String(personalRate));
      localStorage.setItem(KEYS.truckSize, String(truckSize));
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    };

    document.getElementById('resetMonth').onclick = () => {
      if (!confirm('ì •ì‚°(ëª…ì„±/ìŒë´‰)ë§Œ 0ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ì¶œê³ /ì…ê³  ê¸°ë¡ì€ ìœ ì§€ë©ë‹ˆë‹¤)')) return;
      settlement = { myeong:0, eumbong:0 };
      saveJSON(KEYS.settlement, settlement);
      syncHeader();
      alert('ì›”ì´ˆ ì´ˆê¸°í™” ì™„ë£Œ');
    };

    const table = document.getElementById('itemsTable');
    function drawItems(){
      table.innerHTML = '';
      items.forEach((it, idx) => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-1 md:grid-cols-5 gap-2 bg-gray-50 border rounded-2xl p-3';
        row.innerHTML = `
          <input data-i="${idx}" data-f="name" class="border p-2 rounded-xl" value="${it.name}" ${it.lock ? 'disabled' : ''} />
          <input data-i="${idx}" data-f="m" type="number" class="border p-2 rounded-xl" value="${num(it.myeongseong)}" />
          <input data-i="${idx}" data-f="e" type="number" class="border p-2 rounded-xl" value="${num(it.eumbong)}" />
          <div class="text-sm text-gray-500 flex items-center">ëª…ì„±/ìŒë´‰ ë‹¨ê°€</div>
          <button class="rounded-xl bg-slate-800 text-white font-bold py-2" ${it.lock ? 'disabled' : ''} data-del="${idx}">ì‚­ì œ</button>
        `;
        table.appendChild(row);
      });

      table.querySelectorAll('button[data-del]').forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.dataset.del);
          if (!items[idx] || items[idx].lock) return;
          if (!confirm('ì´ í’ˆëª©ì„ ì‚­ì œí• ê¹Œìš”?')) return;
          items.splice(idx, 1);
          drawItems();
        };
      });

      table.querySelectorAll('input[data-f]').forEach(inp => {
        inp.oninput = () => {
          const i = Number(inp.dataset.i);
          const f = inp.dataset.f;
          if (f === 'name') items[i].name = inp.value;
          if (f === 'm') items[i].myeongseong = num(inp.value);
          if (f === 'e') items[i].eumbong = num(inp.value);
        };
      });
    }

    drawItems();

    document.getElementById('addItem').onclick = () => {
      items.push({ name:'ìƒˆ í’ˆëª©', myeongseong:0, eumbong:0 });
      drawItems();
    };

    document.getElementById('saveItems').onclick = () => {
      saveJSON(KEYS.items, items);
      alert('í’ˆëª©/ë‹¨ê°€ ì €ì¥ ì™„ë£Œ');
    };

    // ë°±ì—…
    document.getElementById('backupBtn').onclick = () => {
      const data = {
        items,
        outgoRecords,
        inboundRecords,
        myStock,
        containerHeld,
        settlement,
        personalRate,
        truckSize
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `water_io_backup_${todayISO()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // ë³µì›
    document.getElementById('restoreInput').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!confirm('ì´ íŒŒì¼ë¡œ ë°ì´í„°ë¥¼ ë³µì›í• ê¹Œìš”?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return;

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          items = data.items || items;
          outgoRecords = data.outgoRecords || [];
          inboundRecords = data.inboundRecords || [];
          myStock = data.myStock || myStock;
          containerHeld = data.containerHeld || containerHeld;
          settlement = data.settlement || settlement;
          personalRate = num(data.personalRate || personalRate);
          truckSize = num(data.truckSize || truckSize);

          saveJSON(KEYS.items, items);
          saveJSON(KEYS.outgo, outgoRecords);
          saveJSON(KEYS.inbound, inboundRecords);
          saveJSON(KEYS.myStock, myStock);
          saveJSON(KEYS.containerHeld, containerHeld);
          saveJSON(KEYS.settlement, settlement);
          localStorage.setItem(KEYS.personalRate, String(personalRate));
          localStorage.setItem(KEYS.truckSize, String(truckSize));

          syncHeader();
          alert('ë°ì´í„° ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          show('home');
        } catch(err) {
          alert('ë³µì› ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file);
    };

    document.getElementById('resetAll').onclick = () => {
      if (!confirm('âš  ëª¨ë“  ë°ì´í„°(ì¶œê³ /ì…ê³ /ì •ì‚°/ì¬ê³ /ì„¤ì •)ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.\n\nì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      const keysToRemove = [KEYS.items, KEYS.outgo, KEYS.inbound, KEYS.myStock, KEYS.containerHeld, KEYS.settlement, KEYS.personalRate, KEYS.truckSize];
      keysToRemove.forEach(k => localStorage.removeItem(k));
      // reset runtime state
      items = DEFAULT_ITEMS;
      outgoRecords = [];
      inboundRecords = [];
      myStock = { '18.9L': 0 };
      containerHeld = { ëª…ì„±:{}, ìŒë´‰:{} };
      for (const wh of ['ëª…ì„±','ìŒë´‰']) {
        containerHeld[wh] = {};
        for (const t of CONTAINER_TYPES) containerHeld[wh][t.key] = 0;
      }
      settlement = { myeong:0, eumbong:0 };
      personalRate = 1800;
      truckSize = 864;
      syncHeader();
      alert('ì´ˆê¸°í™” ì™„ë£Œ');
      show('home');
    };
  }

  // ===== ë’¤ë¡œê°€ê¸°(Bì•ˆ) ì²˜ë¦¬ =====
  window.onpopstate = function(e){
    const header = document.getElementById('appHeader');
    // ë©”ì¸ì´ ì•„ë‹Œ ìƒíƒœì—ì„œ ë’¤ë¡œê°€ê¸° â†’ ë©”ì¸ìœ¼ë¡œ
    if (header && header.style.display === 'none') {
      show('home');
      return;
    }
    // ë©”ì¸ì—ì„œ ë’¤ë¡œê°€ê¸° â†’ ì¢…ë£Œ í™•ì¸
    if (confirm('ì•±ì„ ì¢…ë£Œí• ê¹Œìš”?')) {
      history.go(-1);
    } else {
      history.pushState({ screen: 'home' }, '', '#home');
    }
  };

  // initial render
  syncHeader();
  history.replaceState({ screen: 'home' }, '', '#home');

// intro title fade-out
setTimeout(()=>{
  const intro = document.getElementById('introTitle');
  if(intro){
    intro.firstElementChild.classList.add('opacity-0');
    setTimeout(()=>{
      intro.remove();
      const header = document.getElementById('appHeader');
      if(header) header.style.display = 'block';
    }, 500);
  }
}, 1000);

show('home');

</script>
</body>
</html>
